user              nginx;
worker_processes  auto;

pid        /run/nginx.pid;

events {
  worker_connections  1024;
}

map $request_uri $loggable {
  default 1;
  ~^/health 0;
  ~^/metrics 0;
  ~^/stub_status 0;
}

http {
  log_format accesslog_exporter '$http_host\t$request_method\t$status\t$request_time\t$request_length\t$bytes_sent' if=$loggable;
  access_log syslog:server=127.0.0.1:8514,nohostname accesslog_exporter;

  server {
    listen       8080;
    server_name  localhost;

    location = /direct/200 {
      return 200 "OK";
    }
    location = /direct/204 {
      return 204 "No Content";
    }
    location = /direct/404 {
      return 404 "Not Found";
    }
    location = /direct/500 {
      return 500 "Internal Server Error";
    }

    location = /stub_status {
      stub_status;

      allow 127.0.0.1;
      deny all;
    }

    location /httpbin/ {
      proxy_pass http://127.0.0.1:80/;
    }
  }
}
