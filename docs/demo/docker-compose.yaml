services:
  nginx:
    image: nginx:1-alpine-slim
    healthcheck:
      test: [ "CMD", "wget", "-q", "http://127.0.0.1:8090/stub_status","-O","/dev/null" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    depends_on:
      - httpbin
      - access-log-exporter
    environment:
      NGINX_ENTRYPOINT_QUIET_LOGS: "1"
    ports:
      - "8090:8090/tcp"
    networks:
      access-log-exporter:
        aliases:
          - nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
  httpbin:
    image: mccutchen/go-httpbin
    networks:
      access-log-exporter:
        aliases:
          - httpbin
    environment:
      PORT: 8080
  access-log-exporter:
    image: ghcr.io/jkroepke/access-log-exporter:latest
    networks:
      access-log-exporter:
        aliases:
          - access-log-exporter
    ports:
      - "4040:4040/tcp"
    command:
      - --preset=simple_uri_upstream
      - --nginx.scrape-url=http://nginx:8090/stub_status
  load-generator:
    image: golang:1.25
    networks:
      access-log-exporter:
    depends_on:
      - nginx
    environment:
      BASE_URL: http://nginx:8090
    command:
      - go
      - run
      - /main.go
    volumes:
      - ./load-generator/main.go:/main.go
  prometheus:
    image: prom/prometheus
    depends_on:
      - access-log-exporter
    networks:
      access-log-exporter:
        aliases:
          - prometheus
    ports:
      - "9090:9090/tcp"
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.listen-address=:9090
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
  grafana:
    image: grafana/grafana
    networks:
      access-log-exporter:
        aliases:
          - grafana
    ports:
      - "3000:3000/tcp"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./grafana/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml
      - ./grafana/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml
      - ./../../contrib/grafana-dashboard.json:/var/lib/grafana/dashboards/access-log-exporter.json
networks:
  access-log-exporter:
    driver: bridge

volumes:
  prometheus-data:
